<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Expense Tracker v11.3 - Read-Only for Arpita</title>
    
    <!-- PWA Configuration -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Expenses">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23667eea;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%23764ba2;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100' height='100' fill='url(%23grad)' rx='20'/%3E%3Ctext x='50' y='70' font-size='50' font-weight='bold' text-anchor='middle' fill='white' font-family='Arial, sans-serif'%3E‚Çπ%3C/text%3E%3C/svg%3E">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #047857 0%, #065f46 100%);
            background-attachment: fixed;
            min-height: 100vh;
            padding: 16px;
            padding-bottom: 100px;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
        }

        /* Desktop/Mac optimizations */
        @media (min-width: 768px) {
            body {
                padding: 40px 20px;
            }

            .container {
                max-width: 600px;
            }

            .header {
                padding: 32px;
            }

            .header h1 {
                font-size: 32px;
            }

            .tabs {
                gap: 12px;
            }

            .tab {
                padding: 16px 20px;
                font-size: 15px;
            }

            .add-btn-top {
                padding: 18px;
                font-size: 16px;
            }

            .section {
                padding: 28px;
            }

            .transaction {
                padding: 20px;
            }

            .modal-content {
                max-width: 600px;
            }

            /* Hover effects only on desktop */
            .transaction:hover {
                transform: translateY(-3px);
                box-shadow: 0 12px 28px rgba(0, 0, 0, 0.12);
            }

            .btn:hover {
                transform: translateY(-2px);
            }

            .category-item:hover {
                transform: translateX(8px);
            }
        }

        /* Large desktop */
        @media (min-width: 1024px) {
            .container {
                max-width: 700px;
            }

            .header h1 {
                font-size: 36px;
            }

            .transaction {
                padding: 24px;
            }

            .transaction-category {
                font-size: 17px;
            }

            .transaction-amount {
                font-size: 18px;
            }
        }

        .header {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border: none;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 16px;
            animation: fadeInDown 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header h1 {
            font-size: 28px;
            font-weight: 900;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #fbbf24 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 16px;
            text-align: center;
            letter-spacing: -1px;
        }

        .sync-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 16px;
            background: #f0f7ff;
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 13px;
            font-weight: 600;
            color: #667eea;
        }

        .sync-status.connected {
            background: #d1fae5;
            border-color: rgba(16, 185, 129, 0.3);
            color: #059669;
        }

        .sync-status.disconnected {
            background: #f8d7da;
            border-color: rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        .sync-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #22c55e;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .sync-status.disconnected .sync-indicator {
            background: #ef4444;
        }

        .tabs {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 12px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid transparent;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            color: #666;
            letter-spacing: -0.3px;
            text-align: center;
        }

        .tab.active {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-color: transparent;
            color: white;
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.5), 0 0 30px rgba(16, 185, 129, 0.3);
            transform: scale(1.05);
        }

        .tab:hover:not(.active) {
            background: white;
            border-color: rgba(16, 185, 129, 0.3);
            color: #10b981;
        }

        .add-btn-top {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 16px;
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.5), 0 0 30px rgba(16, 185, 129, 0.2);
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            letter-spacing: -0.3px;
        }

        .add-btn-top:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(16, 185, 129, 0.6), 0 0 40px rgba(16, 185, 129, 0.3);
        }

        .add-btn-top:active {
            transform: translateY(0);
        }

        .auth-section {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(40px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            padding: 40px 32px;
            text-align: center;
            animation: fadeInDown 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .auth-section h2 {
            color: #ffffff;
            margin-bottom: 16px;
            font-size: 24px;
            font-weight: 900;
            letter-spacing: -1px;
        }

        .auth-section p {
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 20px;
            line-height: 1.6;
            font-weight: 500;
        }

        .auth-section a {
            color: #667eea;
        }

        .auth-btn {
            padding: 16px 32px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 8px 32px rgba(102, 126, 234, 0.4);
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(102, 126, 234, 0.5);
        }

        .summary {
            background: white;
            border: 3px solid #10b981;
            color: #333;
            padding: 24px;
            border-radius: 16px;
            margin-bottom: 16px;
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.2);
            animation: fadeInUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) 0.1s both;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 14px;
            font-weight: 600;
            color: #666;
        }

        .summary-row span:last-child {
            color: #333;
            font-weight: 700;
        }

        .summary-row.total {
            font-size: 16px;
            font-weight: 800;
            padding-top: 16px;
            border-top: 2px solid #f0f0f0;
            margin-top: 12px;
            margin-bottom: 0;
            color: #10b981;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            gap: 8px;
        }
        
        .summary-row.total span {
            white-space: nowrap;
        }

        .summary-row.total span:last-child {
            color: #10b981;
            font-size: 15px;
        }

        .section {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border: none;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            animation: fadeInUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) 0.2s both;
        }

        .section h2 {
            font-size: 16px;
            font-weight: 800;
            color: #333;
            margin-bottom: 16px;
            letter-spacing: -0.5px;
        }

        .transactions {
            display: none;
        }

        .transactions.active {
            display: block;
        }

        .transaction {
            background: white;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 10px;
            border: 2px solid #f0f0f0;
            border-left: 4px solid #10b981;
            border-right: 4px solid #fbbf24;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .transaction:hover {
            background: #fafafa;
            border-color: #e0e0e0;
            border-left-color: #10b981;
            border-right-color: #fbbf24;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .transaction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .transaction-category {
            font-weight: 700;
            color: #333;
            font-size: 15px;
            letter-spacing: -0.3px;
        }

        .transaction-amount {
            font-size: 16px;
            font-weight: 800;
            color: #f59e0b;
            letter-spacing: -0.5px;
        }

        .transaction-details {
            font-size: 12px;
            color: #666;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .transaction-detail {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: #1a1a2e;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 32px 28px;
            width: 100%;
            max-width: 480px;
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(40px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            font-size: 22px;
            font-weight: 800;
            margin-bottom: 24px;
            color: white;
            letter-spacing: -0.5px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 8px;
            font-size: 13px;
            letter-spacing: -0.3px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 14px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            color: white;
        }

        /* Filter dropdown in transaction headers */
        .transaction-filter {
            background: white !important;
            border: 2px solid #10b981 !important;
            color: #333 !important;
            padding: 8px 12px !important;
            font-size: 13px !important;
            font-weight: 700 !important;
            border-radius: 8px !important;
            cursor: pointer !important;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2) !important;
        }

        .transaction-filter:hover {
            border-color: #059669 !important;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3) !important;
        }

        .transaction-filter:focus {
            outline: none !important;
            border-color: #047857 !important;
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.2) !important;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.08);
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 28px;
        }

        .btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            letter-spacing: -0.3px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.5);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(16, 185, 129, 0.6);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: none;
            color: white;
            font-weight: 700;
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.5);
            transform: translateY(-2px);
        }

        .btn:active {
            transform: scale(0.98);
        }

        .category-breakdown {
            margin-top: 16px;
        }

        .category-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 16px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.2s ease;
        }

        .category-item:last-child {
            margin-bottom: 0;
        }

        .category-item:hover {
            background: #e9ecef;
            transform: translateX(4px);
        }

        .category-name {
            color: #666;
            font-size: 14px;
            font-weight: 600;
        }

        .category-amount {
            font-weight: 700;
            color: #10b981;
        }

        .empty-state {
            text-align: center;
            padding: 48px 20px;
            color: rgba(255, 255, 255, 0.4);
            font-weight: 600;
        }

        .empty-state-icon {
            font-size: 56px;
            margin-bottom: 12px;
            opacity: 0.4;
        }

        .delete-btn {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 700;
            width: auto;
            margin-top: 10px;
            display: inline-block;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .delete-btn:hover {
            background: rgba(239, 68, 68, 0.3);
            border-color: rgba(239, 68, 68, 0.5);
            transform: translateY(-2px);
        }

        .delete-btn:active {
            transform: scale(0.95);
        }

        .loading {
            text-align: center;
            padding: 24px;
            color: #667eea;
            font-weight: 600;
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 1s linear infinite;
            margin: 24px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .user-name-display {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.2);
            padding: 12px 16px;
            border-radius: 10px;
            font-weight: 700;
            color: #667eea;
            text-align: center;
        }

        .month-nav-btn {
            width: 100%;
            padding: 16px;
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(40px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            color: white;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .month-nav-btn:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.12);
            transform: translateY(-2px);
        }

        .month-nav-btn:active {
            transform: translateY(0);
        }

        .back-to-current-btn {
            background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);
            border: none;
            margin-bottom: 16px;
            box-shadow: 0 8px 32px rgba(168, 85, 247, 0.6);
        }

        .back-to-current-btn:hover {
            box-shadow: 0 12px 40px rgba(168, 85, 247, 0.7);
        }

        .month-selector {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .month-selector.active {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .month-selector-content {
            background: #1a1a2e;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 32px 28px;
            width: 100%;
            max-width: 480px;
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .month-selector-header {
            font-size: 20px;
            font-weight: 800;
            margin-bottom: 24px;
            color: white;
            letter-spacing: -0.5px;
        }

        .month-option {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.08);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .month-option:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.12);
            transform: translateY(-2px);
        }

        .month-option:active {
            transform: scale(0.98);
        }

        .month-option-name {
            font-weight: 700;
            color: white;
            font-size: 15px;
            margin-bottom: 6px;
            letter-spacing: -0.3px;
        }

        .month-option-total {
            color: rgba(255, 255, 255, 0.6);
            font-size: 13px;
            font-weight: 600;
        }

        .current-month-indicator {
            display: inline-block;
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: #22c55e;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            margin-left: 8px;
            font-weight: 700;
        }

        /* Settlement Tracker Styles */
        .settlement-header-section {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
        }

        .settlement-month-item {
            background: white;
            padding: 18px 20px;
            border-radius: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settlement-month-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-color: #10b981;
        }

        .settlement-month-item:active {
            transform: scale(0.98);
        }

        .settlement-month-name {
            font-size: 16px;
            font-weight: 700;
            color: #1f2937;
        }

        .settlement-month-status {
            display: inline-flex;
            align-items: center;
            padding: 6px 14px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 700;
        }

        .settlement-month-status.settled {
            background: #d1fae5;
            color: #059669;
            border: 2px solid #10b981;
        }

        .settlement-month-status.not-settled {
            background: #fee2e2;
            color: #dc2626;
            border: 2px solid #ef4444;
        }

        .settlement-container {
            padding: 0;
        }

        .settlement-summary {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            border: 3px solid #10b981;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.15);
        }

        .settlement-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .settlement-row:last-child {
            border-bottom: none;
            padding-top: 18px;
            margin-top: 10px;
            border-top: 2px solid #e5e7eb;
        }

        .settlement-label {
            font-size: 15px;
            color: #6b7280;
            font-weight: 600;
        }

        .settlement-value {
            font-size: 18px;
            font-weight: 800;
            color: #1f2937;
        }

        .settlement-value.total {
            font-size: 24px;
            color: #ef4444;
        }

        .settlement-value.positive {
            color: #10b981;
        }

        .settlement-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid;
        }

        .settlement-status-badge.pending {
            background: #fef3c7;
            color: #f59e0b;
            border-color: #fde68a;
        }

        .settlement-status-badge.pending:hover {
            background: #fde68a;
            transform: translateY(-2px);
        }

        .settlement-status-badge.settled {
            background: #d1fae5;
            color: #10b981;
            border-color: #a7f3d0;
        }

        .settlement-remark {
            display: inline-block;
            margin-left: 12px;
            padding: 6px 12px;
            background: white;
            border: 2px solid #10b981;
            border-radius: 8px;
            font-size: 13px;
            color: #059669;
            font-weight: 600;
        }

        .settlement-actions {
            margin-top: 20px;
            text-align: center;
        }

        /* Modal for settlement remark */
        .remark-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .remark-modal.active {
            display: flex;
        }

        .remark-modal-content {
            background: linear-gradient(135deg, #047857 0%, #065f46 100%);
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .remark-modal-header {
            font-size: 20px;
            font-weight: 800;
            color: white;
            margin-bottom: 20px;
        }

        .remark-input {
            width: 100%;
            padding: 14px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            font-size: 15px;
            color: white;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .remark-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .remark-modal-buttons {
            display: flex;
            gap: 12px;
        }

        .remark-modal-btn {
            flex: 1;
            padding: 14px;
            border-radius: 10px;
            border: none;
            font-weight: 700;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .remark-modal-btn.primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .remark-modal-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Auth Section (shown when not connected) -->
        <div id="auth-section" class="auth-section">
            <h2>üîê Connect to Google Sheets</h2>
            <p>To sync your expenses across devices, you need to connect your Google account.</p>
            <p><strong>‚ö†Ô∏è IMPORTANT: Use fix-sync link first!</strong><br>
            To avoid creating duplicate sheets, please use:<br>
            <a href="./fix-sync.html" style="color: #667eea; font-weight: 600;">fix-sync.html</a> before connecting here.</p>
            <button class="auth-btn" onclick="handleAuthClick()">üîó Connect Google Sheets</button>
        </div>

        <!-- Main App (shown when connected) -->
        <div id="main-app" style="display: none;">
            <!-- Back to Current Month Button (shown when viewing old month) -->
            <button id="back-to-current-btn" class="month-nav-btn back-to-current-btn" style="display: none;" onclick="backToCurrentMonth()">
                ‚Üê Back to Current Month
            </button>

            <div class="header">
                <h1>‚Çπ Expense Tracker</h1>
                <div id="sync-status" class="sync-status disconnected">
                    <div class="sync-indicator"></div>
                    <span>Not connected</span>
                </div>
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('monthly')">Expense</button>
                    <button class="tab" onclick="switchTab('travel')">Travel Expense</button>
                    <button class="tab" onclick="switchTab('personal')">Personal</button>
                    <button class="tab" onclick="switchTab('settlement')">Monthly Settlement</button>
                </div>
                <button class="add-btn-top" onclick="openModal()">‚ûï Add New Expense</button>
            </div>

            <!-- Monthly Tab -->
            <div id="monthly-tab" class="transactions active">
                <div class="summary">
                    <div class="summary-row">
                        <span>üßë Chandan:</span>
                        <span id="monthly-chandan">‚Çπ0</span>
                    </div>
                    <div class="summary-row">
                        <span>üë© Arpita:</span>
                        <span id="monthly-arpita">‚Çπ0</span>
                    </div>
                    <div class="summary-row total">
                        <span>Total:</span>
                        <span id="monthly-total">‚Çπ0</span>
                    </div>
                </div>

                <div class="section">
                    <h2>üìä Category Breakdown</h2>
                    <div id="monthly-categories" class="category-breakdown"></div>
                </div>

                <div class="section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h2 style="margin: 0;">üìù Transactions</h2>
                        <select id="monthly-filter" class="transaction-filter" onchange="updateDisplay()">
                            <option value="all">All</option>
                            <option value="Chandan">Chandan</option>
                            <option value="Arpita">Arpita</option>
                        </select>
                    </div>
                    <div id="monthly-list"></div>
                </div>
            </div>

            <!-- Travel Tab -->
            <div id="travel-tab" class="transactions">
                <div class="summary">
                    <div class="summary-row">
                        <span>üßë Chandan:</span>
                        <span id="travel-chandan">‚Çπ0</span>
                    </div>
                    <div class="summary-row">
                        <span>üë© Arpita:</span>
                        <span id="travel-arpita">‚Çπ0</span>
                    </div>
                    <div class="summary-row total">
                        <span>Total:</span>
                        <span id="travel-total">‚Çπ0</span>
                    </div>
                </div>

                <div class="section">
                    <h2>üìä Category Breakdown</h2>
                    <div id="travel-categories" class="category-breakdown"></div>
                </div>

                <div class="section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h2 style="margin: 0;">üìù Transactions</h2>
                        <select id="travel-filter" class="transaction-filter" onchange="updateDisplay()">
                            <option value="all">All</option>
                            <option value="Chandan">Chandan</option>
                            <option value="Arpita">Arpita</option>
                        </select>
                    </div>
                    <div id="travel-list"></div>
                </div>
            </div>

            <!-- Personal Tab -->
            <div id="personal-tab" class="transactions">
                <div class="summary">
                    <div class="summary-row total">
                        <span id="personal-user-label">My Personal:</span>
                        <span id="personal-total">‚Çπ0</span>
                    </div>
                </div>

                <div class="section">
                    <h2>üìä Category Breakdown</h2>
                    <div id="personal-categories" class="category-breakdown"></div>
                </div>

                <div class="section">
                    <h2>üìù Transactions</h2>
                    <div id="personal-list"></div>
                </div>
            </div>

            <!-- Monthly Settlement Tab -->
            <div id="settlement-tab" class="transactions">
                <div class="settlement-header-section">
                    <h2 style="color: white; font-size: 24px; font-weight: 800; margin-bottom: 8px;">Monthly Settlement</h2>
                    <p style="color: rgba(255,255,255,0.8); font-size: 14px;">Select a month to view settlement details</p>
                </div>

                <!-- Month List View -->
                <div class="section" id="settlement-month-list" style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 2px solid #10b981; padding: 20px;">
                    <h3 style="font-size: 18px; font-weight: 700; color: #1f2937; margin-bottom: 16px;">Select Month</h3>
                    <div id="settlement-months-container"></div>
                </div>

                <!-- Settlement Detail View (hidden initially) -->
                <div class="section" id="settlement-detail-view" style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 2px solid #10b981; padding: 30px; display: none;">
                    <button onclick="backToMonthList()" style="background: rgba(255,255,255,0.5); border: 2px solid #10b981; color: #059669; padding: 10px 20px; border-radius: 8px; font-weight: 700; font-size: 14px; cursor: pointer; margin-bottom: 20px;">
                        ‚Üê Back to Month List
                    </button>
                    <div id="settlement-content"></div>
                </div>
            </div>

            <!-- View Previous Months Button -->
            <button class="month-nav-btn" onclick="openMonthSelector()">
                View Previous Months
            </button>
            
            <!-- Version Info -->
            <div style="text-align: center; padding: 20px 10px 10px 10px; color: rgba(255, 255, 255, 0.7); font-size: 11px; font-weight: 600;">
                Version 11.3 - Read-Only for Arpita
            </div>
        </div>

        <!-- Remark Modal -->
        <div id="remarkModal" class="remark-modal">
            <div class="remark-modal-content">
                <div class="remark-modal-header">Add Settlement Remark</div>
                <input type="text" id="remarkInput" class="remark-input" placeholder="E.g., Paid via UPI, Cash given, etc." maxlength="50">
                <div class="remark-modal-buttons">
                    <button class="remark-modal-btn secondary" onclick="closeRemarkModal()">Cancel</button>
                    <button class="remark-modal-btn primary" onclick="saveRemark()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Month Selector Modal -->
    <div id="month-selector" class="month-selector">
        <div class="month-selector-content">
            <div class="month-selector-header">Select Month to View</div>
            <div id="month-options"></div>
            <button class="btn btn-secondary" style="width: 100%; margin-top: 15px;" onclick="closeMonthSelector()">Cancel</button>
        </div>
    </div>

    <!-- Add Transaction Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Add Expense</div>
            
            <div class="form-group">
                <label class="form-label">Type</label>
                <select class="form-select" id="expense-type" onchange="updateCategories()">
                    <option value="monthly">Expense</option>
                    <option value="travel">Travel Expense</option>
                    <option value="personal">Personal</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Date</label>
                <input type="date" class="form-input" id="date" value="">
            </div>

            <div class="form-group">
                <label class="form-label">Category</label>
                <select class="form-select" id="category">
                    <option value="Grocery">Grocery</option>
                    <option value="Outside Food">Outside Food</option>
                    <option value="Travel Within City">Travel Within City</option>
                    <option value="Rent+Electricity">Rent+Electricity</option>
                    <option value="Vegetables">Vegetables</option>
                    <option value="Other">Other</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Description</label>
                <input type="text" class="form-input" id="description" placeholder="Enter details...">
            </div>

            <div class="form-group">
                <label class="form-label">Amount (‚Çπ)</label>
                <input type="number" class="form-input" id="amount" placeholder="0">
            </div>

            <div class="form-group">
                <label class="form-label">Added By</label>
                <div class="user-name-display" id="spent-by-display">Loading...</div>
                <input type="hidden" id="spent-by">
            </div>

            <div class="form-group">
                <label class="form-label">Payment Mode</label>
                <select class="form-select" id="mode">
                    <option value="Online">Online</option>
                    <option value="Cash">Cash</option>
                    <option value="Credit Card">Credit Card</option>
                </select>
            </div>

            <div class="button-group">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="addTransaction()">Save</button>
            </div>
        </div>
    </div>

    <!-- Google API Client Library -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script>
        // Configuration
        const CLIENT_ID = '892042080548-j6fb856a3ta0pha4326688np2ii1b8lc.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.email';
        
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let spreadsheetId = localStorage.getItem('spreadsheetId');
        let currentTab = 'monthly';
        let expenses = [];
        let currentUserName = '';
        let currentViewMonth = null; // null = current month, otherwise specific month
        let showAllTransactionsMap = {}; // Track which tabs are showing all transactions
        
        const monthlyCategories = ['Grocery', 'Outside Food', 'Travel Within City', 'Rent+Electricity', 'Vegetables', 'Other'];
        const travelCategories = ['Fuel', 'Bike Servicing', 'Food', 'Ticket', 'Stay', 'Other'];
        const personalCategories = ['Shopping', 'Entertainment', 'Food/Drink', 'Personal Care', 'Medical', 'Gifts', 'Hobbies', 'Education', 'Other'];

        // Wait for DOM to be ready
        document.addEventListener('DOMContentLoaded', function() {
            const dateInput = document.getElementById('date');
            if (dateInput) {
                const today = new Date();
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const dd = String(today.getDate()).padStart(2, '0');
                dateInput.value = `${yyyy}-${mm}-${dd}`;
            }
            
            // Initialize Google APIs after DOM is ready
            initGoogleAPIs();
        });

        function initGoogleAPIs() {
            // Check if libraries are loaded
            if (typeof gapi !== 'undefined') {
                gapi.load('client', initializeGapiClient);
            } else {
                console.error('GAPI not loaded');
                setTimeout(initGoogleAPIs, 500);
            }
            
            if (typeof google !== 'undefined' && google.accounts) {
                initializeGIS();
            } else {
                console.error('Google Identity Services not loaded');
                setTimeout(initGoogleAPIs, 500);
            }
        }

        async function initializeGapiClient() {
            try {
                await gapi.client.init({
                    discoveryDocs: [
                        'https://sheets.googleapis.com/$discovery/rest?version=v4',
                        'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'
                    ],
                });
                gapiInited = true;
                console.log('GAPI initialized');
                maybeEnableButtons();
            } catch (error) {
                console.error('Error initializing GAPI:', error);
                alert('Error loading Google Sheets API. Please refresh the page.');
            }
        }

        function initializeGIS() {
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: '', // Will be set later
                    // Pre-fill with saved email for faster re-auth
                    hint: localStorage.getItem('userEmail') || ''
                });
                gisInited = true;
                console.log('GIS initialized');
                maybeEnableButtons();
            } catch (error) {
                console.error('Error initializing GIS:', error);
            }
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                console.log('Both APIs ready');
                // Check if we have a saved token
                const savedToken = localStorage.getItem('gapiToken');
                if (savedToken) {
                    try {
                        const tokenObj = JSON.parse(savedToken);
                        gapi.client.setToken(tokenObj);
                        // Restore user name
                        const savedName = localStorage.getItem('currentUserName');
                        if (savedName) {
                            currentUserName = savedName;
                            showMainApp();
                            loadExpenses();
                            
                            // Start automatic token refresh
                            startTokenRefresh();
                            
                            // Attempt silent token refresh to get a fresh token
                            // This happens in background, user doesn't see anything
                            setTimeout(() => {
                                if (tokenClient) {
                                    console.log('Attempting background token refresh...');
                                    try {
                                        tokenClient.requestAccessToken({prompt: ''});
                                    } catch (e) {
                                        console.log('Background refresh not needed or failed:', e);
                                    }
                                }
                            }, 3000);
                            
                            return;
                        }
                    } catch (e) {
                        console.error('Error restoring token:', e);
                        localStorage.removeItem('gapiToken');
                    }
                }
                
                // Check if we have a current token
                const token = gapi.client.getToken();
                if (token) {
                    localStorage.setItem('gapiToken', JSON.stringify(token));
                    showMainApp();
                    loadExpenses();
                }
            }
        }

        function refreshToken() {
            if (!tokenClient) {
                console.log('No token client available');
                return;
            }
            
            // Check if we actually need to refresh
            const token = gapi.client.getToken();
            if (!token) {
                console.log('No token found, skipping refresh');
                return;
            }
            
            console.log('Refreshing access token...');
            try {
                // Use silent refresh (no popup)
                tokenClient.requestAccessToken({prompt: ''});
                console.log('Token refresh requested');
                
                // Save timestamp of last refresh
                localStorage.setItem('lastTokenRefresh', Date.now().toString());
            } catch (error) {
                console.error('Token refresh failed:', error);
            }
        }

        // Wrapper for API calls that automatically handles auth expiry
        async function callWithAuth(apiCallFunction) {
            try {
                // Try the API call
                return await apiCallFunction();
            } catch (error) {
                console.log('API call error:', error);
                
                // Check if it's an auth error (401 or 403)
                if (error.status === 401 || error.status === 403 || 
                    (error.result && error.result.error && 
                     (error.result.error.code === 401 || error.result.error.code === 403))) {
                    
                    console.log('Authentication expired, refreshing...');
                    
                    // Show a small loading message
                    const statusEl = document.getElementById('sync-status');
                    const originalStatus = statusEl.innerHTML;
                    statusEl.innerHTML = '<div class="sync-indicator"></div>Refreshing session...';
                    statusEl.className = 'sync-status disconnected';
                    
                    // Try to refresh the token (happens in popup, but stays on page)
                    return new Promise((resolve, reject) => {
                        if (!tokenClient) {
                            reject(new Error('No token client available'));
                            return;
                        }
                        
                        // Set up callback for this refresh
                        const originalCallback = tokenClient.callback;
                        tokenClient.callback = async (response) => {
                            if (response.error) {
                                statusEl.innerHTML = originalStatus;
                                statusEl.className = 'sync-status disconnected';
                                reject(new Error('Re-authentication failed'));
                                return;
                            }
                            
                            // Token refreshed! Save it
                            const newToken = gapi.client.getToken();
                            if (newToken) {
                                localStorage.setItem('gapiToken', JSON.stringify(newToken));
                                localStorage.setItem('lastTokenRefresh', Date.now().toString());
                            }
                            
                            // Restore status
                            statusEl.innerHTML = originalStatus;
                            statusEl.className = 'sync-status connected';
                            
                            // Retry the original API call
                            try {
                                const result = await apiCallFunction();
                                resolve(result);
                            } catch (retryError) {
                                reject(retryError);
                            }
                            
                            // Restore original callback
                            tokenClient.callback = originalCallback;
                        };
                        
                        // Request new token (small popup, stays on page)
                        tokenClient.requestAccessToken({prompt: ''});
                    });
                } else {
                    // Not an auth error, just throw it
                    throw error;
                }
            }
        }

        // More aggressive token refresh - every 45 minutes instead of 50
        let refreshInterval = null;
        
        function startTokenRefresh() {
            // Clear any existing interval
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            
            // Check if we need immediate refresh based on last refresh time
            const lastRefresh = localStorage.getItem('lastTokenRefresh');
            if (lastRefresh) {
                const timeSinceRefresh = Date.now() - parseInt(lastRefresh);
                const minutesSince = timeSinceRefresh / (1000 * 60);
                
                // If more than 30 minutes since last refresh, do it now
                if (minutesSince > 30) {
                    console.log(`${minutesSince.toFixed(0)} minutes since last refresh, refreshing now...`);
                    setTimeout(refreshToken, 1000);
                }
            }
            
            // SUPER AGGRESSIVE: Refresh every 30 minutes (was 45)
            // This ensures token NEVER expires while app is open
            refreshInterval = setInterval(refreshToken, 30 * 60 * 1000);
            console.log('Token auto-refresh started (every 30 minutes)');
        }
        
        // Proactive token check on app open/visibility
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && gapi.client.getToken()) {
                console.log('App became visible, checking token age...');
                
                const lastRefresh = localStorage.getItem('lastTokenRefresh');
                if (lastRefresh) {
                    const timeSinceRefresh = Date.now() - parseInt(lastRefresh);
                    const minutesSince = timeSinceRefresh / (1000 * 60);
                    
                    console.log(`Last token refresh was ${minutesSince.toFixed(0)} minutes ago`);
                    
                    // AGGRESSIVE: If more than 20 minutes, refresh immediately
                    // This catches you before token expires
                    if (minutesSince > 20) {
                        console.log('Token getting old, refreshing proactively...');
                        setTimeout(refreshToken, 500);
                    }
                } else {
                    // No last refresh record, refresh to be safe
                    console.log('No refresh record, refreshing token...');
                    setTimeout(refreshToken, 500);
                }
                
                // Restart the interval
                startTokenRefresh();
            }
        });
        
        // Also check on page load
        window.addEventListener('load', function() {
            const token = localStorage.getItem('gapiToken');
            if (token) {
                const lastRefresh = localStorage.getItem('lastTokenRefresh');
                if (lastRefresh) {
                    const timeSinceRefresh = Date.now() - parseInt(lastRefresh);
                    const minutesSince = timeSinceRefresh / (1000 * 60);
                    
                    // If token might be expired, clear it for clean re-auth
                    if (minutesSince > 50) {
                        console.log('Token likely expired, will need re-auth');
                        // Don't clear - let silent refresh handle it
                    }
                }
            }
        });

        function handleAuthClick() {
            if (!tokenClient) {
                alert('Google services not loaded yet. Please wait a moment and try again.');
                return;
            }

            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    console.error('Auth error:', resp);
                    alert('Authentication failed: ' + resp.error);
                    return;
                }
                console.log('Auth successful');
                
                // Get and store user email
                try {
                    const userInfo = await gapi.client.request({
                        'path': 'https://www.googleapis.com/oauth2/v2/userinfo'
                    });
                    const email = userInfo.result.email;
                    localStorage.setItem('userEmail', email);
                    
                    // Determine user name from email
                    if (email.toLowerCase().includes('cksasingh') || email.toLowerCase().includes('chandan')) {
                        currentUserName = 'Chandan';
                    } else if (email.toLowerCase().includes('arpita') || email.toLowerCase().includes('rathi')) {
                        currentUserName = 'Arpita';
                    } else {
                        // Default to asking user
                        currentUserName = prompt('What is your name? (Chandan or Arpita)', 'Chandan');
                    }
                    
                    localStorage.setItem('currentUserName', currentUserName);
                    console.log('User name:', currentUserName, 'Email:', email);
                } catch (e) {
                    console.error('Error getting user info:', e);
                    currentUserName = 'Chandan'; // Default
                }
                
                // Save token to localStorage
                const token = gapi.client.getToken();
                if (token) {
                    localStorage.setItem('gapiToken', JSON.stringify(token));
                    localStorage.setItem('lastTokenRefresh', Date.now().toString());
                }
                
                showMainApp();
                await initializeSpreadsheet();
                loadExpenses();
                
                // Start automatic token refresh
                startTokenRefresh();
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        function showMainApp() {
            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            updateSyncStatus(true);
        }

        function updateSyncStatus(connected) {
            const statusEl = document.getElementById('sync-status');
            if (connected) {
                statusEl.className = 'sync-status connected';
                statusEl.querySelector('span').textContent = `‚úì Synced as ${currentUserName}`;
            } else {
                statusEl.className = 'sync-status disconnected';
                statusEl.querySelector('span').textContent = '‚úó Not connected';
            }
        }

        async function initializeSpreadsheet() {
            if (spreadsheetId) {
                console.log('Using existing spreadsheet:', spreadsheetId);
                return;
            }

            // No spreadsheet ID - this shouldn't happen as we redirect to fix-sync
            console.error('No spreadsheet ID found!');
            alert('‚ö†Ô∏è Setup required!\n\nPlease use the setup page first.');
            window.location.href = '/fix-sync.html';
        }

        async function addHeaders(sheetName) {
            const headers = [['Date', 'Category', 'Description', 'Spent By', 'Mode', 'Amount']];
            
            try {
                await callWithAuth(async () => {
                    return await gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: spreadsheetId,
                        range: `${sheetName}!A1:F1`,
                        valueInputOption: 'RAW',
                        resource: {
                            values: headers
                        }
                    });
                });
            } catch (error) {
                console.error('Error adding headers:', error);
            }
        }

        async function getOrCreateSheet(type, date) {
            const monthYear = new Date(date).toLocaleString('en-IN', { month: 'short', year: 'numeric' });
            let sheetName;
            
            if (type === 'monthly') {
                sheetName = `Expense - ${monthYear}`;
            } else if (type === 'travel') {
                sheetName = `Travel Expense - ${monthYear}`;
            } else if (type === 'personal') {
                sheetName = `Personal - ${monthYear}`;
            }
            
            try {
                // Check if sheet exists
                const response = await callWithAuth(async () => {
                    return await gapi.client.sheets.spreadsheets.get({
                        spreadsheetId: spreadsheetId
                    });
                });

                const sheets = response.result.sheets;
                const sheetExists = sheets.some(sheet => sheet.properties.title === sheetName);

                if (!sheetExists) {
                    // Create new sheet
                    await callWithAuth(async () => {
                        return await gapi.client.sheets.spreadsheets.batchUpdate({
                            spreadsheetId: spreadsheetId,
                            resource: {
                                requests: [{
                                    addSheet: {
                                        properties: {
                                            title: sheetName
                                        }
                                    }
                                }]
                            }
                        });
                    });

                    // Add headers
                    await addHeaders(sheetName);
                }

                return sheetName;
            } catch (error) {
                console.error('Error getting/creating sheet:', error);
                return null;
            }
        }

        async function loadExpenses() {
            if (!spreadsheetId) return;

            try {
                const response = await callWithAuth(async () => {
                    return await gapi.client.sheets.spreadsheets.get({
                        spreadsheetId: spreadsheetId
                    });
                });

                expenses = [];
                const sheets = response.result.sheets;

                for (const sheet of sheets) {
                    const sheetName = sheet.properties.title;
                    let type = null;
                    
                    if (sheetName.startsWith('Expense -')) {
                        type = 'monthly';
                    } else if (sheetName.startsWith('Travel Expense -')) {
                        type = 'travel';
                    } else if (sheetName.startsWith('Personal -')) {
                        type = 'personal';
                    }

                    if (!type) continue;

                    const values = await callWithAuth(async () => {
                        return await gapi.client.sheets.spreadsheets.values.get({
                            spreadsheetId: spreadsheetId,
                            range: `${sheetName}!A2:F`
                        });
                    });

                    const rows = values.result.values || [];
                    rows.forEach((row, index) => {
                        if (row.length >= 6) {
                            expenses.push({
                                id: `${sheetName}-${index}`,
                                sheetName: sheetName,
                                rowIndex: index + 2, // +2 because header is row 1, data starts at row 2
                                type: type,
                                date: row[0],
                                category: row[1],
                                description: row[2],
                                spentBy: row[3],
                                mode: row[4],
                                amount: parseFloat(row[5]) || 0
                            });
                        }
                    });
                }

                updateDisplay();
            } catch (error) {
                console.error('Error loading expenses:', error);
                
                // Show user-friendly message
                const statusEl = document.getElementById('sync-status');
                if (statusEl) {
                    statusEl.innerHTML = '<div class="sync-indicator"></div>Reconnecting...';
                    statusEl.className = 'sync-status disconnected';
                }
                
                // Try to reload after a moment
                setTimeout(() => {
                    console.log('Retrying to load expenses...');
                    loadExpenses();
                }, 2000);
            }
        }

        function updateCategories() {
            const type = document.getElementById('expense-type').value;
            const categorySelect = document.getElementById('category');
            let categories;
            
            if (type === 'monthly') {
                categories = monthlyCategories;
            } else if (type === 'travel') {
                categories = travelCategories;
            } else if (type === 'personal') {
                categories = personalCategories;
            }
            
            categorySelect.innerHTML = categories.map(cat => 
                `<option value="${cat}">${cat}</option>`
            ).join('');
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.transactions').forEach(t => t.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`${tab}-tab`).classList.add('active');
            
            updateDisplay();
        }

        function openModal() {
            document.getElementById('modal').classList.add('active');
            document.getElementById('expense-type').value = currentTab;
            updateCategories();
            
            // Set date to today in YYYY-MM-DD format
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            document.getElementById('date').value = `${yyyy}-${mm}-${dd}`;
            
            // Set user name
            document.getElementById('spent-by').value = currentUserName;
            document.getElementById('spent-by-display').textContent = currentUserName;
            document.getElementById('spent-by-display').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            document.getElementById('date').value = `${yyyy}-${mm}-${dd}`;
            document.getElementById('description').value = '';
            document.getElementById('amount').value = '';
        }

        async function addTransaction() {
            const type = document.getElementById('expense-type').value;
            const date = document.getElementById('date').value;
            const category = document.getElementById('category').value;
            const description = document.getElementById('description').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const spentBy = document.getElementById('spent-by').value;
            const mode = document.getElementById('mode').value;

            if (!date || !amount || amount <= 0) {
                alert('Please fill all required fields!');
                return;
            }
            
            if (!spentBy) {
                alert('Error: Could not determine who is adding this expense. Please refresh and try again.');
                return;
            }

            const dateObj = new Date(date);
            const formattedDate = dateObj.toLocaleDateString('en-IN', { 
                day: 'numeric', 
                month: 'short',
                year: 'numeric'
            });

            // Get or create appropriate sheet
            const sheetName = await getOrCreateSheet(type, date);
            if (!sheetName) {
                alert('Error creating sheet. Please try again.');
                return;
            }

            try {
                // Append to sheet - with automatic re-auth if token expired
                await callWithAuth(async () => {
                    return await gapi.client.sheets.spreadsheets.values.append({
                        spreadsheetId: spreadsheetId,
                        range: `${sheetName}!A:F`,
                        valueInputOption: 'RAW',
                        resource: {
                            values: [[formattedDate, category, description, spentBy, mode, amount]]
                        }
                    });
                });

                closeModal();
                await loadExpenses();
                alert('‚úÖ Expense added and synced!');
            } catch (error) {
                console.error('Error adding transaction:', error);
                alert('Error adding expense. Please try again.');
            }
        }

        async function deleteTransaction(sheetName, rowIndex) {
            if (!confirm('Are you sure you want to delete this expense?')) {
                return;
            }

            try {
                // Delete the row from the sheet
                await callWithAuth(async () => {
                    return await gapi.client.sheets.spreadsheets.batchUpdate({
                        spreadsheetId: spreadsheetId,
                        resource: {
                            requests: [{
                                deleteDimension: {
                                    range: {
                                        sheetId: await getSheetId(sheetName),
                                        dimension: 'ROWS',
                                        startIndex: rowIndex - 1,
                                        endIndex: rowIndex
                                    }
                                }
                            }]
                        }
                    });
                });

                alert('‚úÖ Expense deleted!');
                await loadExpenses();
            } catch (error) {
                console.error('Error deleting:', error);
                alert('Error deleting expense. Please try again.');
            }
        }

        async function getSheetId(sheetName) {
            const response = await callWithAuth(async () => {
                return await gapi.client.sheets.spreadsheets.get({
                    spreadsheetId: spreadsheetId
                });
            });
            const sheet = response.result.sheets.find(s => s.properties.title === sheetName);
            return sheet ? sheet.properties.sheetId : null;
        }

        function updateDisplay() {
            // Get the month to display (either selected month or current month)
            const now = new Date();
            const displayMonth = currentViewMonth || now.toLocaleString('en-IN', { month: 'short', year: 'numeric' });
            
            ['monthly', 'travel', 'personal'].forEach(type => {
                // Filter expenses to display month
                let typeExpenses = expenses.filter(e => {
                    if (e.type !== type) return false;
                    
                    // Check if expense is from display month
                    const expenseDate = new Date(e.date);
                    const expenseMonth = expenseDate.toLocaleString('en-IN', { month: 'short', year: 'numeric' });
                    return expenseMonth === displayMonth;
                });
                
                // For personal tab, filter by current user only
                if (type === 'personal') {
                    typeExpenses = typeExpenses.filter(e => e.spentBy === currentUserName);
                }
                
                // Calculate totals
                let chandanTotal = 0;
                let arpitaTotal = 0;
                
                typeExpenses.forEach(exp => {
                    if (exp.spentBy === 'Chandan') chandanTotal += exp.amount;
                    if (exp.spentBy === 'Arpita') arpitaTotal += exp.amount;
                });
                
                const total = chandanTotal + arpitaTotal;
                
                // Update summary
                if (type === 'personal') {
                    // Personal tab shows only user's total (no name needed since it's their view)
                    document.getElementById('personal-user-label').textContent = 'Total:';
                    document.getElementById('personal-total').textContent = `‚Çπ${total.toLocaleString('en-IN')} ‚Ä¢ ${displayMonth}`;
                } else {
                    document.getElementById(`${type}-chandan`).textContent = `‚Çπ${chandanTotal.toLocaleString('en-IN')}`;
                    document.getElementById(`${type}-arpita`).textContent = `‚Çπ${arpitaTotal.toLocaleString('en-IN')}`;
                    document.getElementById(`${type}-total`).textContent = `‚Çπ${total.toLocaleString('en-IN')} ‚Ä¢ ${displayMonth}`;
                }
                
                // Category breakdown
                const categories = {};
                typeExpenses.forEach(exp => {
                    categories[exp.category] = (categories[exp.category] || 0) + exp.amount;
                });
                
                const categoryHTML = Object.entries(categories)
                    .sort((a, b) => b[1] - a[1])
                    .map(([cat, amt]) => `
                        <div class="category-item">
                            <span class="category-name">${cat}</span>
                            <span class="category-amount">‚Çπ${amt.toLocaleString('en-IN')}</span>
                        </div>
                    `).join('');
                
                document.getElementById(`${type}-categories`).innerHTML = categoryHTML || 
                    `<div class="empty-state">No expenses in ${displayMonth}</div>`;
                // Get filter value
                const filterValue = type === 'personal' ? currentUserName : (document.getElementById(`${type}-filter`)?.value || 'all');
                
                // Apply filter
                let filteredExpenses = typeExpenses;
                if (filterValue !== 'all') {
                    filteredExpenses = typeExpenses.filter(e => e.spentBy === filterValue);
                }
                
                // Transaction list (show transactions, sorted by when they were added - newest first)
                const sortedExpenses = filteredExpenses.sort((a, b) => {
                    // First sort by date (newest date first)
                    const dateCompare = new Date(b.date) - new Date(a.date);
                    if (dateCompare !== 0) return dateCompare;
                    
                    // If same date, sort by rowIndex (higher row = added later = show first)
                    return b.rowIndex - a.rowIndex;
                });
                
                // Check if we should show all or just 5
                const showAll = showAllTransactionsMap[type] || false;
                const displayExpenses = showAll ? sortedExpenses : sortedExpenses.slice(0, 5);
                const hasMore = sortedExpenses.length > 5;
                
                const listHTML = displayExpenses.map(exp => `
                    <div class="transaction">
                        <div class="transaction-header">
                            <span class="transaction-category">${exp.category}</span>
                            <span class="transaction-amount">‚Çπ${exp.amount.toLocaleString('en-IN')}</span>
                        </div>
                        <div class="transaction-details">
                            <span class="transaction-detail">${exp.date}</span>
                            ${type !== 'personal' ? `<span class="transaction-detail">üë§ ${exp.spentBy}</span>` : ''}
                            <span class="transaction-detail">üí≥ ${exp.mode}</span>
                        </div>
                        ${exp.description ? `<div style="margin-top: 8px; color: #666; font-size: 13px;">${exp.description}</div>` : ''}
                        ${exp.spentBy === currentUserName ? `<button class="delete-btn" onclick="deleteTransaction('${exp.sheetName}', ${exp.rowIndex})">üóëÔ∏è Delete</button>` : ''}
                    </div>
                `).join('');
                
                const viewMoreBtn = (hasMore && !showAll) ? 
                    `<button class="btn btn-secondary" style="width: 100%; margin-top: 15px; font-size: 14px;" onclick="toggleShowAll('${type}')">View More</button>` : 
                    (showAll && hasMore) ? 
                    `<button class="btn btn-secondary" style="width: 100%; margin-top: 15px; font-size: 14px;" onclick="toggleShowAll('${type}')">Show Less</button>` : '';
                
                document.getElementById(`${type}-list`).innerHTML = (listHTML || 
                    `<div class="empty-state"><div class="empty-state-icon">üì≠</div><div>No transactions in ${displayMonth}. Tap + to add!</div></div>`) + viewMoreBtn;
            });
            
            // Render settlement month list
            renderSettlementMonthList();
        }

        // Settlement Tab Functions
        async function getSettlementData(month) {
            // Try to read from Settlements sheet first (if available)
            try {
                if (gapi && gapi.client && gapi.client.sheets) {
                    // Read from Settlements sheet
                    const values = await callWithAuth(async () => {
                        return await gapi.client.sheets.spreadsheets.values.get({
                            spreadsheetId: spreadsheetId,
                            range: 'Settlements!A:L'
                        });
                    });
                    
                    if (values && values.result && values.result.values) {
                        const rows = values.result.values;
                        // Find the row for this month (skip header row)
                        for (let i = 1; i < rows.length; i++) {
                            if (rows[i][0] === month) {
                                // Found the month! Return all data
                                return {
                                    expenseChandanPaid: parseFloat(rows[i][1]) || 0,
                                    expenseArpitaPaid: parseFloat(rows[i][2]) || 0,
                                    expenseArpitaOwes: parseFloat(rows[i][3]) || 0,
                                    travelChandanPaid: parseFloat(rows[i][4]) || 0,
                                    travelArpitaPaid: parseFloat(rows[i][5]) || 0,
                                    travelArpitaOwes: parseFloat(rows[i][6]) || 0,
                                    totalFinalAmount: parseFloat(rows[i][7]) || 0,
                                    whoOwesWhom: rows[i][8] || '',
                                    settled: rows[i][9] === 'true',
                                    remark: rows[i][10] || '',
                                    settledAt: rows[i][11] || null
                                };
                            }
                        }
                    }
                }
            } catch (error) {
                console.log('Could not load from Settlements sheet, using localStorage:', error.message);
            }
            
            // Fallback to localStorage (always works)
            const key = `settlement_data_${month}`;
            const stored = localStorage.getItem(key);
            return stored ? JSON.parse(stored) : { settled: false, remark: '', settledAt: null };
        }

        // Function to ensure Settlements sheet exists (auto-create if needed)
        async function ensureSettlementsSheetExists() {
            try {
                if (!gapi || !gapi.client || !gapi.client.sheets) {
                    return false;
                }

                // First, check if sheet already exists
                const response = await callWithAuth(async () => {
                    return await gapi.client.sheets.spreadsheets.get({
                        spreadsheetId: spreadsheetId
                    });
                });

                const sheets = response.result.sheets || [];
                const settlementsSheet = sheets.find(s => s.properties.title === 'Settlements');

                if (settlementsSheet) {
                    console.log('Settlements sheet already exists');
                    return true;
                }

                // Sheet doesn't exist, create it
                console.log('Creating Settlements sheet...');
                
                await callWithAuth(async () => {
                    return await gapi.client.sheets.spreadsheets.batchUpdate({
                        spreadsheetId: spreadsheetId,
                        resource: {
                            requests: [{
                                addSheet: {
                                    properties: {
                                        title: 'Settlements',
                                        gridProperties: {
                                            rowCount: 100,
                                            columnCount: 12
                                        }
                                    }
                                }
                            }]
                        }
                    });
                });

                console.log('Settlements sheet created successfully');

                // Add headers
                const headers = [
                    'Month',
                    'Expense_Chandan_Paid',
                    'Expense_Arpita_Paid',
                    'Expense_Arpita_Owes',
                    'Travel_Chandan_Paid',
                    'Travel_Arpita_Paid',
                    'Travel_Arpita_Owes',
                    'Total_Final_Amount',
                    'Who_Owes_Whom',
                    'Settled',
                    'Remark',
                    'Settled_Date'
                ];

                await callWithAuth(async () => {
                    return await gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: spreadsheetId,
                        range: 'Settlements!A1:L1',
                        valueInputOption: 'RAW',
                        resource: {
                            values: [headers]
                        }
                    });
                });

                console.log('Settlements sheet headers added');
                return true;

            } catch (error) {
                console.error('Error ensuring Settlements sheet exists:', error);
                return false;
            }
        }

        async function saveSettlementData(month, data, calculationData) {
            // Always save to localStorage first (reliable backup)
            const key = `settlement_data_${month}`;
            localStorage.setItem(key, JSON.stringify(data));
            
            // Only Chandan can save to Google Sheets
            if (currentUserName !== 'Chandan') {
                return; // Arpita can't save, but localStorage is updated for her view
            }
            
            // Try to save to Settlements sheet (if available)
            try {
                if (gapi && gapi.client && gapi.client.sheets) {
                    // Ensure Settlements sheet exists (creates if needed)
                    const sheetExists = await ensureSettlementsSheetExists();
                    
                    if (!sheetExists) {
                        console.log('Could not create Settlements sheet, using localStorage only');
                        return;
                    }
                    // First, check if Settlements sheet exists and get all data
                    let existingRows = [];
                    let rowToUpdate = -1;
                    
                    try {
                        const values = await callWithAuth(async () => {
                            return await gapi.client.sheets.spreadsheets.values.get({
                                spreadsheetId: spreadsheetId,
                                range: 'Settlements!A:L'
                            });
                        });
                        
                        if (values && values.result && values.result.values) {
                            existingRows = values.result.values;
                            // Find if this month already exists
                            for (let i = 1; i < existingRows.length; i++) {
                                if (existingRows[i][0] === month) {
                                    rowToUpdate = i + 1; // +1 because sheets are 1-indexed
                                    break;
                                }
                            }
                        }
                    } catch (readError) {
                        console.log('Settlements sheet might not exist yet:', readError.message);
                    }
                    
                    // Prepare the data row
                    const dataRow = [
                        month,
                        calculationData.expenseChandanPaid || 0,
                        calculationData.expenseArpitaPaid || 0,
                        calculationData.expenseArpitaOwes || 0,
                        calculationData.travelChandanPaid || 0,
                        calculationData.travelArpitaPaid || 0,
                        calculationData.travelArpitaOwes || 0,
                        calculationData.totalFinalAmount || 0,
                        calculationData.whoOwesWhom || '',
                        data.settled ? 'true' : 'false',
                        data.remark || '',
                        data.settledAt || ''
                    ];
                    
                    if (rowToUpdate > 0) {
                        // Update existing row
                        await callWithAuth(async () => {
                            return await gapi.client.sheets.spreadsheets.values.update({
                                spreadsheetId: spreadsheetId,
                                range: `Settlements!A${rowToUpdate}:L${rowToUpdate}`,
                                valueInputOption: 'RAW',
                                resource: {
                                    values: [dataRow]
                                }
                            });
                        });
                        console.log('Updated settlement in Settlements sheet for', month);
                    } else {
                        // Append new row
                        await callWithAuth(async () => {
                            return await gapi.client.sheets.spreadsheets.values.append({
                                spreadsheetId: spreadsheetId,
                                range: 'Settlements!A:L',
                                valueInputOption: 'RAW',
                                insertDataOption: 'INSERT_ROWS',
                                resource: {
                                    values: [dataRow]
                                }
                            });
                        });
                        console.log('Added new settlement to Settlements sheet for', month);
                    }
                }
            } catch (error) {
                console.log('Could not save to Settlements sheet, saved to localStorage:', error.message);
            }
        }

        async function renderSettlementMonthList() {
            const container = document.getElementById('settlement-months-container');
            
            // Get all unique months from expenses
            const monthsSet = new Set();
            expenses.forEach(exp => {
                const expenseDate = new Date(exp.date);
                const month = expenseDate.toLocaleString('en-IN', { month: 'short', year: 'numeric' });
                monthsSet.add(month);
            });
            
            // Convert to array and sort (newest first)
            const months = Array.from(monthsSet).sort((a, b) => {
                const dateA = new Date(a + ' 1');
                const dateB = new Date(b + ' 1');
                return dateB - dateA;
            });
            
            if (months.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280; font-size: 16px;">No expenses yet. Start adding to see settlements!</div>';
                return;
            }
            
            // Get current month
            const now = new Date();
            const currentMonth = now.toLocaleString('en-IN', { month: 'short', year: 'numeric' });
            
            // Load all settlement data in parallel
            const settlementDataPromises = months.map(month => getSettlementData(month));
            const settlementDataArray = await Promise.all(settlementDataPromises);
            
            const monthsHTML = months.map((month, index) => {
                const settlementData = settlementDataArray[index];
                const statusClass = settlementData.settled ? 'settled' : 'not-settled';
                const statusText = settlementData.settled ? 'Settled' : 'Not Settled';
                const isCurrent = month === currentMonth;
                
                return `
                    <div class="settlement-month-item" onclick="viewSettlementDetails('${month}')">
                        <span class="settlement-month-name">
                            ${month}
                            ${isCurrent ? '<span style="display: inline-block; margin-left: 8px; background: #3b82f6; color: white; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700;">Current</span>' : ''}
                        </span>
                        <span class="settlement-month-status ${statusClass}">${statusText}</span>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = monthsHTML;
        }

        function viewSettlementDetails(month) {
            // Hide month list, show detail view
            document.getElementById('settlement-month-list').style.display = 'none';
            document.getElementById('settlement-detail-view').style.display = 'block';
            
            // Render the details for this month
            renderSettlementDetail(month);
        }

        function backToMonthList() {
            // Show month list, hide detail view
            document.getElementById('settlement-month-list').style.display = 'block';
            document.getElementById('settlement-detail-view').style.display = 'none';
            
            // Refresh the month list in case status changed
            renderSettlementMonthList();
        }

        async function renderSettlementDetail(displayMonth) {
            const container = document.getElementById('settlement-content');
            
            // Calculate Monthly (Expense) - Both pay 50/50
            const monthlyExpenses = expenses.filter(e => {
                if (e.type !== 'monthly') return false;
                const expenseDate = new Date(e.date);
                const expenseMonth = expenseDate.toLocaleString('en-IN', { month: 'short', year: 'numeric' });
                return expenseMonth === displayMonth;
            });
            
            let monthlyChandanTotal = 0;
            let monthlyArpitaTotal = 0;
            monthlyExpenses.forEach(exp => {
                if (exp.spentBy === 'Chandan') monthlyChandanTotal += exp.amount;
                if (exp.spentBy === 'Arpita') monthlyArpitaTotal += exp.amount;
            });
            
            const monthlyTotal = monthlyChandanTotal + monthlyArpitaTotal;
            const monthlyHalf = monthlyTotal / 2;
            
            // Determine who owes for monthly (50/50)
            let monthlyArpitaOwes = 0;
            let monthlyChandanOwes = 0;
            if (monthlyChandanTotal > monthlyArpitaTotal) {
                monthlyArpitaOwes = monthlyChandanTotal - monthlyHalf;
            } else if (monthlyArpitaTotal > monthlyChandanTotal) {
                monthlyChandanOwes = monthlyArpitaTotal - monthlyHalf;
            }
            
            // Calculate Travel - Arpita pays 100%
            const travelExpenses = expenses.filter(e => {
                if (e.type !== 'travel') return false;
                const expenseDate = new Date(e.date);
                const expenseMonth = expenseDate.toLocaleString('en-IN', { month: 'short', year: 'numeric' });
                return expenseMonth === displayMonth;
            });
            
            let travelChandanTotal = 0;
            let travelArpitaTotal = 0;
            travelExpenses.forEach(exp => {
                if (exp.spentBy === 'Chandan') travelChandanTotal += exp.amount;
                if (exp.spentBy === 'Arpita') travelArpitaTotal += exp.amount;
            });
            
            const travelTotal = travelChandanTotal + travelArpitaTotal;
            // Arpita should pay 100%, so if Chandan paid anything, Arpita owes that
            const travelArpitaOwes = travelChandanTotal;
            
            // Calculate final settlement
            const totalArpitaOwes = monthlyArpitaOwes + travelArpitaOwes;
            const finalOwed = totalArpitaOwes - monthlyChandanOwes;
            
            // Get settlement status (now async)
            const settlementData = await getSettlementData(displayMonth);
            
            container.innerHTML = `
                <div class="settlement-summary">
                    <h3 style="font-size: 20px; font-weight: 800; color: #1f2937; margin-bottom: 20px;">Month: ${displayMonth}</h3>
                    
                    <!-- Expense Section -->
                    <div style="background: #f9fafb; padding: 16px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #e5e7eb;">
                        <h4 style="font-size: 16px; font-weight: 700; color: #10b981; margin-bottom: 12px;">üìä Expense</h4>
                        
                        <div class="settlement-row" style="border-bottom: 1px solid #e5e7eb; padding: 8px 0;">
                            <span class="settlement-label">Chandan Paid:</span>
                            <span class="settlement-value" style="font-size: 16px;">‚Çπ${Math.round(monthlyChandanTotal).toLocaleString('en-IN')}</span>
                        </div>
                        
                        <div class="settlement-row" style="border-bottom: 1px solid #e5e7eb; padding: 8px 0;">
                            <span class="settlement-label">Arpita Paid:</span>
                            <span class="settlement-value" style="font-size: 16px;">‚Çπ${Math.round(monthlyArpitaTotal).toLocaleString('en-IN')}</span>
                        </div>
                        
                        <div class="settlement-row" style="border-bottom: none; padding: 8px 0; margin-top: 8px;">
                            <span class="settlement-label" style="font-weight: 700;">
                                ${monthlyArpitaOwes > 0 ? 'Arpita owes:' : monthlyChandanOwes > 0 ? 'Chandan owes:' : 'All clear:'}
                            </span>
                            <span class="settlement-value" style="font-size: 18px; color: ${monthlyArpitaOwes > 0 || monthlyChandanOwes > 0 ? '#ef4444' : '#10b981'};">
                                ‚Çπ${Math.round(Math.max(monthlyArpitaOwes, monthlyChandanOwes)).toLocaleString('en-IN')}
                            </span>
                        </div>
                    </div>
                    
                    <!-- Travel Expense Section -->
                    <div style="background: #fffbeb; padding: 16px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #fde68a;">
                        <h4 style="font-size: 16px; font-weight: 700; color: #f59e0b; margin-bottom: 12px;">‚úàÔ∏è Travel Expense</h4>
                        
                        <div class="settlement-row" style="border-bottom: 1px solid #fde68a; padding: 8px 0;">
                            <span class="settlement-label">Chandan Paid:</span>
                            <span class="settlement-value" style="font-size: 16px;">‚Çπ${Math.round(travelChandanTotal).toLocaleString('en-IN')}</span>
                        </div>
                        
                        <div class="settlement-row" style="border-bottom: 1px solid #fde68a; padding: 8px 0;">
                            <span class="settlement-label">Arpita Paid:</span>
                            <span class="settlement-value" style="font-size: 16px;">‚Çπ${Math.round(travelArpitaTotal).toLocaleString('en-IN')}</span>
                        </div>
                        
                        <div class="settlement-row" style="border-bottom: none; padding: 8px 0; margin-top: 8px;">
                            <span class="settlement-label" style="font-weight: 700;">Arpita owes:</span>
                            <span class="settlement-value" style="font-size: 18px; color: ${travelArpitaOwes > 0 ? '#ef4444' : '#10b981'};">‚Çπ${Math.round(travelArpitaOwes).toLocaleString('en-IN')}</span>
                        </div>
                    </div>
                    
                    <!-- Final Settlement -->
                    <div style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); padding: 20px; border-radius: 12px; border: 3px solid #10b981;">
                        <div class="settlement-row" style="border-bottom: none;">
                            <span class="settlement-label" style="font-size: 15px; color: #1f2937; font-weight: 800;">
                                ${finalOwed > 0 ? 'Arpita owes to Chandan:' : finalOwed < 0 ? 'Chandan owes to Arpita:' : 'All Clear:'}
                            </span>
                            <span class="settlement-value total ${settlementData.settled ? 'positive' : ''}" style="font-size: 22px;">
                                ‚Çπ${Math.round(Math.abs(finalOwed)).toLocaleString('en-IN')}
                            </span>
                        </div>
                    </div>
                    
                    <div style="margin-top: 24px; padding-top: 20px; border-top: 2px solid #e5e7eb; text-align: center;">
                        ${currentUserName === 'Chandan' ? `
                            <span class="settlement-status-badge ${settlementData.settled ? 'settled' : 'pending'}" onclick="${settlementData.settled ? 'toggleSettlement(\'' + displayMonth + '\')' : 'openRemarkModal(\'' + displayMonth + '\')'}">
                                ${settlementData.settled ? 'Settled' : 'Not Settled'}
                            </span>
                        ` : `
                            <span class="settlement-status-badge ${settlementData.settled ? 'settled' : 'pending'}" style="cursor: default; opacity: 0.9;">
                                ${settlementData.settled ? 'Settled' : 'Not Settled'}
                            </span>
                        `}
                        ${settlementData.settled && settlementData.remark ? 
                            `<span class="settlement-remark">üí¨ ${settlementData.remark}</span>` : 
                            ''
                        }
                        ${settlementData.settled && settlementData.settledAt ? 
                            `<div style="margin-top: 12px; font-size: 13px; color: #10b981; font-weight: 600;">Settled on: ${new Date(settlementData.settledAt).toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' })}</div>` :
                            ''
                        }
                        ${currentUserName !== 'Chandan' ? `
                            <div style="margin-top: 16px; padding: 12px; background: #fef3c7; border: 2px solid #fbbf24; border-radius: 10px; font-size: 13px; color: #92400e; font-weight: 600;">
                                üëÄ View Only - Only Chandan can mark settlements
                            </div>
                        ` : ''}
                    </div>
                    
                    ${Math.abs(finalOwed) < 1 ? `
                        <div style="text-align: center; margin-top: 20px; padding: 20px; background: #f0fdf4; border-radius: 12px; border: 2px solid #10b981;">
                            <div style="font-size: 48px; margin-bottom: 10px;">‚úÖ</div>
                            <div style="font-size: 18px; font-weight: 700; color: #10b981;">All Clear! No settlement needed.</div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        let currentSettlementMonth = '';

        function openRemarkModal(month) {
            currentSettlementMonth = month;
            document.getElementById('remarkInput').value = '';
            document.getElementById('remarkModal').classList.add('active');
        }

        function closeRemarkModal() {
            document.getElementById('remarkModal').classList.remove('active');
            currentSettlementMonth = '';
        }

        // Helper function to calculate settlement data for a given month
        function calculateSettlementData(month) {
            // Calculate Monthly (Expense) - Both pay 50/50
            const monthlyExpenses = expenses.filter(e => {
                if (e.type !== 'monthly') return false;
                const expenseDate = new Date(e.date);
                const expenseMonth = expenseDate.toLocaleString('en-IN', { month: 'short', year: 'numeric' });
                return expenseMonth === month;
            });
            
            let monthlyChandanTotal = 0;
            let monthlyArpitaTotal = 0;
            monthlyExpenses.forEach(exp => {
                if (exp.spentBy === 'Chandan') monthlyChandanTotal += exp.amount;
                if (exp.spentBy === 'Arpita') monthlyArpitaTotal += exp.amount;
            });
            
            const monthlyTotal = monthlyChandanTotal + monthlyArpitaTotal;
            const monthlyHalf = monthlyTotal / 2;
            
            let monthlyArpitaOwes = 0;
            let monthlyChandanOwes = 0;
            if (monthlyChandanTotal > monthlyArpitaTotal) {
                monthlyArpitaOwes = monthlyChandanTotal - monthlyHalf;
            } else if (monthlyArpitaTotal > monthlyChandanTotal) {
                monthlyChandanOwes = monthlyArpitaTotal - monthlyHalf;
            }
            
            // Calculate Travel - Arpita pays 100%
            const travelExpenses = expenses.filter(e => {
                if (e.type !== 'travel') return false;
                const expenseDate = new Date(e.date);
                const expenseMonth = expenseDate.toLocaleString('en-IN', { month: 'short', year: 'numeric' });
                return expenseMonth === month;
            });
            
            let travelChandanTotal = 0;
            let travelArpitaTotal = 0;
            travelExpenses.forEach(exp => {
                if (exp.spentBy === 'Chandan') travelChandanTotal += exp.amount;
                if (exp.spentBy === 'Arpita') travelArpitaTotal += exp.amount;
            });
            
            const travelArpitaOwes = travelChandanTotal;
            
            // Calculate final settlement
            const totalArpitaOwes = monthlyArpitaOwes + travelArpitaOwes;
            const finalOwed = totalArpitaOwes - monthlyChandanOwes;
            
            // Determine who owes whom
            let whoOwesWhom = '';
            if (finalOwed > 0) {
                whoOwesWhom = 'Arpita owes Chandan';
            } else if (finalOwed < 0) {
                whoOwesWhom = 'Chandan owes Arpita';
            } else {
                whoOwesWhom = 'All Clear';
            }
            
            return {
                expenseChandanPaid: monthlyChandanTotal,
                expenseArpitaPaid: monthlyArpitaTotal,
                expenseArpitaOwes: monthlyArpitaOwes,
                travelChandanPaid: travelChandanTotal,
                travelArpitaPaid: travelArpitaTotal,
                travelArpitaOwes: travelArpitaOwes,
                totalFinalAmount: Math.abs(finalOwed),
                whoOwesWhom: whoOwesWhom
            };
        }

        async function saveRemark() {
            const remark = document.getElementById('remarkInput').value.trim();
            if (!remark) {
                alert('Please enter a remark');
                return;
            }
            
            const settlementData = {
                settled: true,
                remark: remark,
                settledAt: new Date().toISOString()
            };
            
            // Calculate all the settlement data
            const calculationData = calculateSettlementData(currentSettlementMonth);
            
            await saveSettlementData(currentSettlementMonth, settlementData, calculationData);
            closeRemarkModal();
            // Re-render the detail view
            await renderSettlementDetail(currentSettlementMonth);
        }

        async function toggleSettlement(month) {
            if (confirm('Mark this as NOT settled?')) {
                const settlementData = {
                    settled: false,
                    remark: '',
                    settledAt: null
                };
                
                // Calculate all the settlement data (still needed for history)
                const calculationData = calculateSettlementData(month);
                
                await saveSettlementData(month, settlementData, calculationData);
                // Re-render the detail view
                await renderSettlementDetail(month);
            }
        }


        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered:', registration);
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }

        // Install prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install button after user is authenticated
            setTimeout(() => {
                if (document.getElementById('main-app').style.display !== 'none') {
                    showInstallPrompt();
                }
            }, 3000);
        });

        function showInstallPrompt() {
            if (deferredPrompt && !localStorage.getItem('appInstalled')) {
                const installBanner = document.createElement('div');
                installBanner.style.cssText = `
                    position: fixed;
                    bottom: 80px;
                    left: 10px;
                    right: 10px;
                    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
                    color: white;
                    padding: 15px;
                    border-radius: 15px;
                    box-shadow: 0 5px 20px rgba(0,0,0,0.3);
                    z-index: 999;
                    text-align: center;
                    font-size: 14px;
                `;
                installBanner.innerHTML = `
                    <div style="margin-bottom: 10px;">üì± Install app on your home screen?</div>
                    <button onclick="installApp()" style="background: white; color: #11998e; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; margin-right: 10px; cursor: pointer;">Install</button>
                    <button onclick="dismissInstall()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">Later</button>
                `;
                document.body.appendChild(installBanner);
                window.installBanner = installBanner;
            }
        }

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('App installed');
                        localStorage.setItem('appInstalled', 'true');
                    }
                    deferredPrompt = null;
                    if (window.installBanner) {
                        window.installBanner.remove();
                    }
                });
            }
        }

        function dismissInstall() {
            if (window.installBanner) {
                window.installBanner.remove();
            }
        }

        function toggleShowAll(type) {
            showAllTransactionsMap[type] = !showAllTransactionsMap[type];
            updateDisplay();
        }

        function openMonthSelector() {
            // Get all unique months from expenses
            const months = new Set();
            expenses.forEach(exp => {
                const expDate = new Date(exp.date);
                const monthYear = expDate.toLocaleString('en-IN', { month: 'short', year: 'numeric' });
                months.add(monthYear);
            });

            // Sort months (newest first)
            const sortedMonths = Array.from(months).sort((a, b) => {
                const dateA = new Date(a);
                const dateB = new Date(b);
                return dateB - dateA;
            });

            // Get current month
            const now = new Date();
            const currentMonth = now.toLocaleString('en-IN', { month: 'short', year: 'numeric' });

            // Build month options
            const monthOptionsHTML = sortedMonths.map(month => {
                // Calculate total for this month
                const monthExpenses = expenses.filter(exp => {
                    const expDate = new Date(exp.date);
                    const expMonth = expDate.toLocaleString('en-IN', { month: 'short', year: 'numeric' });
                    return expMonth === month;
                });
                const total = monthExpenses.reduce((sum, exp) => sum + exp.amount, 0);
                
                const isCurrent = month === currentMonth;
                
                return `
                    <div class="month-option" onclick="selectMonth('${month}')">
                        <div class="month-option-name">
                            ${month}
                            ${isCurrent ? '<span class="current-month-indicator">Current</span>' : ''}
                        </div>
                        <div class="month-option-total">Total: ‚Çπ${total.toLocaleString('en-IN')}</div>
                    </div>
                `;
            }).join('');

            document.getElementById('month-options').innerHTML = monthOptionsHTML || '<div class="empty-state">No expense history yet</div>';
            document.getElementById('month-selector').classList.add('active');
        }

        function closeMonthSelector() {
            document.getElementById('month-selector').classList.remove('active');
        }

        function selectMonth(month) {
            currentViewMonth = month;
            closeMonthSelector();
            updateDisplay();
            
            // Show back button
            document.getElementById('back-to-current-btn').style.display = 'block';
            
            // Scroll to top
            window.scrollTo(0, 0);
        }

        function backToCurrentMonth() {
            currentViewMonth = null;
            updateDisplay();
            
            // Hide back button
            document.getElementById('back-to-current-btn').style.display = 'none';
            
            // Scroll to top
            window.scrollTo(0, 0);
        }
    </script>
</body>
</html>